<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Calcite相关日志分析</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.page-description {
    margin-bottom: 2em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-default_background {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 237, 214, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-default_background {
	color: inherit;
	fill: inherit;
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 237, 214, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-uiBlue { background-color: rgba(35, 131, 226, .07); }
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-transparentGray { background-color: rgba(227, 226, 224, 0); }
.select-value-color-translucentGray { background-color: rgba(0, 0, 0, 0.06); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(249, 228, 188, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }
.select-value-color-pageGlass { background-color: undefined; }
.select-value-color-washGlass { background-color: undefined; }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="623f6c72-ba09-4a31-b12d-7a8e3aa23bdd" class="page sans"><header><h1 class="page-title">Calcite相关日志分析</h1><p class="page-description"></p></header><div class="page-body"><p id="63421f6b-3f08-41a8-b3c9-e00a98423bc5" class="">
</p><h3 id="feaf3be4-8de1-4a9b-812c-9c2330d04c86" class="">1. <code>14:57:20 [http-nio-9080-exec-2] DEBUG org.apache.calcite.sql.parser 890 - Reduced DAYOFWEEK(</code>imp_date<code>) - 2</code></h3><ul id="2cfde2c5-0013-4563-bcd2-1ce23924e24a" class="bulleted-list"><li style="list-style-type:disc"><strong>含义</strong>: 这行日志记录了SQL解析过程中对<code>DAYOFWEEK(imp_date) - 2</code>表达式的简化。Calcite解析器正在处理SQL表达式，并减少了其中的复杂性。</li></ul><h3 id="d80cd71c-799d-44f0-8a94-18ae86e16524" class="">2. <code>14:57:22 [http-nio-9080-exec-2] DEBUG org.apache.calcite.sql2rel 628 - Plan after converting SqlNode to RelNode</code></h3><ul id="fb2c97cb-5917-4354-b085-2e71325b1ebf" class="bulleted-list"><li style="list-style-type:disc"><strong>含义</strong>: 这条日志表明，Calcite已经完成了从<code>SqlNode</code>（SQL解析树）到<code>RelNode</code>（关系表达式树）的转换，并显示了转换后的逻辑执行计划。</li></ul><ul id="89ca7eb3-2bbc-4333-8f0b-e8f6926e44b3" class="bulleted-list"><li style="list-style-type:disc"><strong>计划细节</strong>:<ul id="090e5529-b897-4e16-9666-c93debafce12" class="bulleted-list"><li style="list-style-type:circle"><code>LogicalProject(sys_imp_date=[$0], pv=[$2])</code>: 这是一个投影操作，选择了<code>sys_imp_date</code>和<code>pv</code>两列。</li></ul><ul id="b7aecc1f-ad67-4498-81b7-92f553049d21" class="bulleted-list"><li style="list-style-type:circle"><code>LogicalAggregate(group=[{0, 1}], s2_pv_uv_statis_pv=[SUM($2)])</code>: 这是一个聚合操作，按<code>sys_imp_date</code>和<code>imp_date</code>分组，并计算<code>s2_pv_uv_statis_pv</code>的总和。</li></ul><ul id="43294829-a52d-4ce2-9afa-316c49b8ae29" class="bulleted-list"><li style="list-style-type:circle"><code>LogicalTableScan(table=[[s2_pv_uv_statis]])</code>: 这表示对<code>s2_pv_uv_statis</code>表的扫描。</li></ul></li></ul><h3 id="67ca9ced-8d8b-429c-b938-34925c67f192" class="">3. <code>14:57:22 [http-nio-9080-exec-2] DEBUG c.t.s.h.c.t.c.sql.node.SemanticNode 423 - RelNode optimize SELECT imp_date AS sys_imp_date, SUM(1) AS pv FROM s2_pv_uv_statis GROUP BY imp_date, imp_date</code></h3><ul id="bbe9b6fc-b4d9-4294-aafd-388ee1c9161e" class="bulleted-list"><li style="list-style-type:disc"><strong>含义</strong>: 这个日志记录了经过优化的查询计划，显示了SQL查询优化后的形式。这里展示的是一个聚合查询，计算<code>s2_pv_uv_statis</code>表中<code>imp_date</code>字段的总和，并将其作为<code>sys_imp_date</code>返回。</li></ul><ul id="6642bebb-3f2c-4d11-a2cd-0623c89c3122" class="bulleted-list"><li style="list-style-type:disc"><strong>优化后的SQL</strong>:<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="26dea61d-2f5b-4f73-8951-c97e7468c91a" class="code"><code class="language-SQL" style="white-space:pre-wrap;word-break:break-all">SELECT imp_date AS sys_imp_date, SUM(1) AS pv
FROM s2_pv_uv_statis
GROUP BY imp_date, imp_date</code></pre></li></ul><h3 id="eda965c6-0f5e-4fb3-9456-2ad9a982052c" class="">4. <code>14:57:22 [http-nio-9080-exec-2] DEBUG o.a.c.p.A.rule_execution_summary 300 - Rule Attempts Info for HepPlanner</code></h3><ul id="036bd934-67cf-4c89-bc03-79eb59ad14df" class="bulleted-list"><li style="list-style-type:disc"><strong>含义</strong>: 这条日志显示了HepPlanner（Calcite的规划器之一）在优化过程中尝试应用的规则信息。通常情况下，HepPlanner会应用一系列规则来优化查询。</li></ul><h3 id="fb0b22a9-ae67-40cf-be1e-7817ae6aff83" class="">5. <code>14:57:22 [http-nio-9080-exec-2] DEBUG o.a.c.p.A.rule_execution_summary 301 - Rules Attempts Time (us) * Total 0 0</code></h3><ul id="2a58bf10-fdf6-4cf9-befd-2078cbb4e390" class="bulleted-list"><li style="list-style-type:disc"><strong>含义</strong>: 这个日志记录显示，没有任何规则被应用或尝试优化（Attempts为0，时间也为0微秒）。这可能表示该特定步骤或优化阶段没有执行任何规则应用。</li></ul><h3 id="83466698-a14f-4235-b0e6-532e4d56dbb8" class="">6. <code>14:57:22 [http-nio-9080-exec-2] DEBUG o.apache.calcite.plan.RelOptPlanner 380 - For final plan, using rel#18:LogicalProject.(input=HepRelVertex#17,inputs=0,exprs=[$2])</code></h3><ul id="23431b76-49c3-4718-bd51-95ff39e95b65" class="bulleted-list"><li style="list-style-type:disc"><strong>含义</strong>: 这是日志显示在最终计划中使用的一个<code>LogicalProject</code>操作，指定了从HepPlanner（Calcite优化器的一部分）产生的一个顶点作为输入，并应用了一个投影操作。</li></ul><h3 id="695bdd6c-2d78-4e4f-ba63-fbd7749cd4e0" class="">7. <code>14:57:22 [http-nio-9080-exec-2] DEBUG o.apache.calcite.plan.RelOptPlanner 380 - For final plan, using rel#16:LogicalAggregate.(input=HepRelVertex#15,group={0, 1},s2_pv_uv_statis_pv=SUM($2))</code></h3><ul id="25de1a9f-6744-4f20-982d-6be20d271793" class="bulleted-list"><li style="list-style-type:disc"><strong>含义</strong>: 这行日志记录了另一个优化后的逻辑计划，显示了一个<code>LogicalAggregate</code>操作，它根据分组字段<code>{0, 1}</code>（通常对应于<code>sys_imp_date</code>和<code>imp_date</code>）进行聚合，并计算<code>s2_pv_uv_statis_pv</code>的总和。</li></ul><h3 id="8e6497eb-1cfd-46c4-a057-196d40388bbd" class="">8. <code>14:57:22 [http-nio-9080-exec-2] DEBUG o.apache.calcite.plan.RelOptPlanner 380 - For final plan, using rel#14:LogicalProject.(input=HepRelVertex#13,exprs=[$4, $4, 1])</code></h3><ul id="9165f436-b84d-43ac-8841-ad9b3562f024" class="bulleted-list"><li style="list-style-type:disc"><strong>含义</strong>: 这是另一个<code>LogicalProject</code>操作，在最终的计划中投影了表达式<code>[$4, $4, 1]</code>。这里的<code>$4</code>可能是某个字段的索引值，<code>1</code>是常量值。</li></ul><h3 id="06d9053a-3d5c-47cb-91a5-b40e746520f8" class="">9. <code>14:57:22 [http-nio-9080-exec-2] DEBUG o.apache.calcite.plan.RelOptPlanner 380 - For final plan, using rel#1:LogicalTableScan.(table=[s2_pv_uv_statis])</code></h3><ul id="e7c921b9-fad9-4f57-b768-9f5772700945" class="bulleted-list"><li style="list-style-type:disc"><strong>含义</strong>: 最后，日志记录了最终计划中使用的<code>LogicalTableScan</code>操作，这表示将扫描<code>s2_pv_uv_statis</code>表的数据作为执行计划的一部分。</li></ul><h3 id="43476e0e-1537-4c21-ab54-f08a02451452" class="">总结</h3><p id="3f016f0d-a30a-4cef-b485-a52ec66cdf56" class="">录了从SQL语句解析、优化到最终执行计划的生成过程。Apache Calcite先是简化了SQL表达式，然后将其转换为关系表达式（RelNode），再通过应用各种优化规则生成了最终的逻辑执行计划。这个过程展示了如何有效地从SQL到物理执行计划的转换，并通过优化器应用了多种优化策略。</p><h2 id="2908baae-41c1-4b5c-ae4c-22366e2d269e" class="">10. </h2><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="4f98a544-0593-47e2-af7d-9e96bab48786" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">14:57:22 [http-nio-9080-exec-2] DEBUG org.apache.calcite.sql.parser 890 - Reduced `sys_imp_date` &gt;= &#x27;2024-07-31&#x27; AND `sys_imp_date` &lt;= &#x27;2024-08-06&#x27;</code></pre><ul id="e9a28aa3-6bdc-4b3a-8cb4-2e7aae541602" class="bulleted-list"><li style="list-style-type:disc"><strong>解释</strong>:<ul id="eb564995-927e-40ea-8a3a-facc0a6d63c1" class="bulleted-list"><li style="list-style-type:circle">表示 Calcite SQL 解析器已经解析并简化了条件表达式，该表达式检查 <code>sys_imp_date</code> 字段是否在 <code>&#x27;2024-07-31&#x27;</code> 和 <code>&#x27;2024-08-06&#x27;</code> 之间。这是 SQL 解析和优化过程中常见的一步，确保表达式在进一步处理和执行之前尽可能简洁和高效。</li></ul></li></ul><h2 id="ad950b83-e56e-4465-978d-b7bc7a10d816" class="">11. </h2><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="c9bf4084-872d-4426-90a0-84d6d0803420" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">14:57:22 [http-nio-9080-exec-2] DEBUG org.apache.calcite.sql2rel 628 - Plan after converting SqlNode to RelNode
LogicalAggregate(group=[{}], EXPR$0=[SUM($0)])
  LogicalProject(pv=[$1])
    LogicalFilter(condition=[AND(&gt;=($0, _UTF-8&#x27;2024-07-31&#x27;), &lt;=($0, _UTF-8&#x27;2024-08-06&#x27;))])
      LogicalProject(sys_imp_date=[$0], pv=[$1])
        LogicalAggregate(group=[{0}], pv=[SUM($1)])
          LogicalProject(imp_date=[$4], $f1=[1])
            LogicalTableScan(table=[[s2_pv_uv_statis]])</code></pre><ul id="0f4c5a11-1088-49f7-964a-879f457994da" class="bulleted-list"><li style="list-style-type:disc"><strong>解释</strong>:<ul id="1cd48e8e-9743-4ecb-a0d2-60631b884dda" class="bulleted-list"><li style="list-style-type:circle">这一行展示了 SQL 查询在转换为逻辑查询计划 (RelNode) 后的样子。Calcite 使用 Relational Algebra（关系代数）的表示法来描述查询操作的逻辑步骤。</li></ul><ul id="f193ba1d-083e-4073-859a-3e36ed3fb443" class="bulleted-list"><li style="list-style-type:circle"><strong>具体逻辑步骤</strong>:<ol type="1" id="f62dcd50-d2ab-4432-aa30-f57c4217d5c6" class="numbered-list" start="1"><li><strong>LogicalAggregate</strong>:<ul id="8c21554a-c24d-4b93-8d40-c40ad7f9691c" class="bulleted-list"><li style="list-style-type:disc">这是一个聚合操作（如 SUM、COUNT 等）。</li></ul><ul id="78ead282-7c1c-4f11-905a-d29f394eb1a5" class="bulleted-list"><li style="list-style-type:disc"><code>group=[{}]</code> 表示没有分组字段（即全局聚合）。</li></ul><ul id="80fd22df-0538-483e-b99c-e4d0a3c6e254" class="bulleted-list"><li style="list-style-type:disc"><code>EXPR$0=[SUM($0)]</code> 表示对 <code>$0</code> 列进行 SUM 聚合运算。</li></ul></li></ol><ol type="1" id="b81e8b2d-a0ce-4c42-9269-b6d633c3cb98" class="numbered-list" start="2"><li><strong>LogicalProject</strong>:<ul id="c4cefd1f-1ea5-4a4c-9258-1b2207097caa" class="bulleted-list"><li style="list-style-type:disc">表示列投影操作，选择和重命名特定列。</li></ul><ul id="4074f1f2-e8d5-4412-9243-6a0e88b72b6a" class="bulleted-list"><li style="list-style-type:disc"><code>pv=[$1]</code> 表示选择第二列并将其命名为 <code>pv</code>。</li></ul></li></ol><ol type="1" id="5bcea792-bce1-430e-8c56-b8c1ec8cd3ad" class="numbered-list" start="3"><li><strong>LogicalFilter</strong>:<ul id="fe5aa1e8-93a9-4584-bf8e-25fcc3843916" class="bulleted-list"><li style="list-style-type:disc">表示过滤操作（类似 SQL 的 WHERE 子句）。</li></ul><ul id="84abab62-4968-4eaa-9238-af0ab16bc9ef" class="bulleted-list"><li style="list-style-type:disc"><code>condition=[AND(&gt;=($0, _UTF-8&#x27;2024-07-31&#x27;), &lt;=($0, _UTF-8&#x27;2024-08-06&#x27;))]</code> 表示对第一个列（$0，也就是 <code>sys_imp_date</code>）应用条件过滤，检查其是否在 <code>2024-07-31</code> 和 <code>2024-08-06</code> 之间。</li></ul></li></ol><ol type="1" id="5d4581b2-840e-4340-b5c2-34db4df85c2f" class="numbered-list" start="4"><li><strong>LogicalProject</strong>:<ul id="1f88577d-da5a-4223-9ac7-9bae47726a4e" class="bulleted-list"><li style="list-style-type:disc">再次进行列投影，选择 <code>sys_imp_date</code> 和 <code>pv</code> 列。</li></ul></li></ol><ol type="1" id="15d98fff-c8ab-4851-abbd-f7d17e94ddf6" class="numbered-list" start="5"><li><strong>LogicalAggregate</strong>:<ul id="198b7fa5-1c0d-4c20-bb5d-dbdfbddc3284" class="bulleted-list"><li style="list-style-type:disc">对第一个列（$0，也就是 <code>sys_imp_date</code>）进行分组，对第二个列（$1，也就是 <code>pv</code>）进行 SUM 聚合。</li></ul></li></ol><ol type="1" id="0b1599fa-c240-4c1f-9703-3e69d05e26a5" class="numbered-list" start="6"><li><strong>LogicalProject</strong>:<ul id="8d2c74a0-63ba-4b39-ac7d-31e4f508dd10" class="bulleted-list"><li style="list-style-type:disc">再次进行列投影，选择 <code>imp_date</code> 并创建一个常量列 <code>$f1</code>，值为 1。</li></ul></li></ol><ol type="1" id="ed5fb2c3-30c7-4a27-a8bf-ed1795a9fb1d" class="numbered-list" start="7"><li><strong>LogicalTableScan</strong>:<ul id="a8b3b461-083c-4e51-84ad-4e58c6665451" class="bulleted-list"><li style="list-style-type:disc">表示从物理表 <code>s2_pv_uv_statis</code> 中扫描数据，这是逻辑计划中最底层的操作，用于从实际的数据表中读取数据。</li></ul></li></ol></li></ul></li></ul><h2 id="1c63fc9e-2039-4692-b3cb-675a5bd9aa56" class="">12. </h2><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="5c0035ef-eed2-4bcd-9299-82d25dc98d77" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">14:57:22 [http-nio-9080-exec-2] DEBUG org.apache.calcite.sql2rel 628 - Plan after converting SqlNode to RelNode
LogicalAggregate(group=[{}], EXPR$0=[SUM($0)])
  LogicalProject(pv=[$1])
    LogicalFilter(condition=[AND(&gt;=($0, _UTF-8&#x27;2024-07-31&#x27;), &lt;=($0, _UTF-8&#x27;2024-08-06&#x27;))])
      LogicalProject(sys_imp_date=[$0], pv=[$1])
        LogicalAggregate(group=[{0}], pv=[SUM($1)])
          LogicalProject(imp_date=[$4], $f1=[1])
            LogicalTableScan(table=[[s2_pv_uv_statis]])</code></pre><ul id="ee3a49c8-8368-4fb2-aa74-547f4af661d9" class="bulleted-list"><li style="list-style-type:disc"><strong>解释</strong>:<ul id="9d7a84af-c144-442f-b944-038616207771" class="bulleted-list"><li style="list-style-type:circle">这行与前一行的内容完全相同，Calcite 再次展示了逻辑查询计划的转换结果。这可能是在日志输出时的重复展示，确保在优化和转换过程的不同阶段查看该计划。</li></ul></li></ul><p id="8eea9429-e00e-41a0-9643-95d2f4ab2cad" class="">
</p><h2 id="a5330000-afd6-4e7f-89ed-b5964b8421d8" class="">13. semanticNode 代码解析</h2><p id="2367f23f-1eb7-4ad0-93b2-a346ad269c56" class=""><code>com.tencent.supersonic.headless.core.translator.calcite.sql.node</code> 包，主要定义了 <code>SemanticNode</code> 抽象类。这类代码使用了 Apache Calcite 进行 SQL 解析、优化和转换，是整个 SQL 处理链条中的一部分。下面我将逐步分析代码的各个部分及其作用。</p><p id="ca9006a0-78e7-4e10-a0da-35073e4b8201" class="">类和包的结构</p><ul id="bce8404e-0e46-4dbf-a973-459435fff862" class="bulleted-list"><li style="list-style-type:disc"><strong>包名:</strong> <code>com.tencent.supersonic.headless.core.translator.calcite.sql.node</code><ul id="130a56a4-112a-4b9a-9051-621a6564e6c4" class="bulleted-list"><li style="list-style-type:circle">该包通常用于处理 SQL 语句的解析和转换，将 SQL 语句转化为 Calcite 的内部表达方式（如 RelNode）并执行优化。</li></ul></li></ul><ul id="45affa21-ea39-4a64-892d-6c7ecc614d09" class="bulleted-list"><li style="list-style-type:disc"><strong>类名:</strong> <code>SemanticNode</code><ul id="e601152b-6877-4fa7-9306-7add1ae15406" class="bulleted-list"><li style="list-style-type:circle">这是一个抽象类，提供了多个静态方法来解析、处理、优化和转换 SQL 语句。</li></ul></li></ul><p id="3c999659-7d80-4fb5-8d2c-0e51036c9adf" class="">核心字段</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="978ada71-ecc1-40ab-8aac-0993a824d02f" class="code"><code class="language-Java" style="white-space:pre-wrap;word-break:break-all">public static Set&lt;SqlKind&gt; AGGREGATION_KIND = new HashSet&lt;&gt;();
public static Set&lt;String&gt; AGGREGATION_FUNC = new HashSet&lt;&gt;();
public static List&lt;String&gt; groupHints = new ArrayList&lt;&gt;(Arrays.asList(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;));</code></pre><ul id="44c0e973-002b-4b38-bfe5-42442ee407c8" class="bulleted-list"><li style="list-style-type:disc"><strong>AGGREGATION_KIND</strong>:<ul id="752712ef-a383-49e8-a86e-a548d44492a3" class="bulleted-list"><li style="list-style-type:circle">这个集合存储了所有支持的聚合操作（如 AVG、COUNT、SUM、MAX、MIN）。<code>SqlKind</code> 是 Calcite 用来表示 SQL 语句中不同操作类型的枚举。</li></ul></li></ul><ul id="b732808c-b8ed-4108-a337-be5a01390ae1" class="bulleted-list"><li style="list-style-type:disc"><strong>AGGREGATION_FUNC</strong>:<ul id="c16b5382-5ccc-4f91-a9be-d6d6566c3156" class="bulleted-list"><li style="list-style-type:circle">该集合存储了聚合函数的名称字符串（如 &quot;sum&quot;, &quot;count&quot;, &quot;max&quot;, &quot;avg&quot;, &quot;min&quot;），用于匹配和识别 SQL 中的聚合函数。</li></ul></li></ul><ul id="b38535e6-6f22-4a2f-8c63-5c1fbfe68586" class="bulleted-list"><li style="list-style-type:disc"><strong>groupHints</strong>:<ul id="a78b6cee-f924-4491-ab96-1ad07802cd0e" class="bulleted-list"><li style="list-style-type:circle">这是一个存储数字字符串的列表，用于处理 SQL 中的分组提示（Group hints），这些可能是对 SQL 中分组操作的特定索引或标识。</li></ul></li></ul><p id="a294f125-f057-4a5f-8515-ae1ff845355f" class="">核心方法</p><ol type="1" id="e6a91653-660e-449d-ae72-ef4e20caa38c" class="numbered-list" start="1"><li><strong>parse</strong> 方法</li></ol><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2fa6dfb8-6e62-4ebd-8c06-9b496be06701" class="code"><code class="language-Java" style="white-space:pre-wrap;word-break:break-all">public static SqlNode parse(String expression, SqlValidatorScope scope, EngineType engineType) throws Exception {
    SqlValidatorWithHints sqlValidatorWithHints = Configuration.getSqlValidatorWithHints(
            scope.getValidator().getCatalogReader().getRootSchema(), engineType);
    if (Configuration.getSqlAdvisor(sqlValidatorWithHints, engineType).getReservedAndKeyWords()
            .contains(expression.toUpperCase())) {
        expression = String.format(&quot;`%s`&quot;, expression);
    }
    SqlParser sqlParser = SqlParser.create(expression, Configuration.getParserConfig(engineType));
    SqlNode sqlNode = sqlParser.parseExpression();
    scope.validateExpr(sqlNode);
    return sqlNode;
}</code></pre><ul id="4caed449-549c-4d8f-a688-b304e000e8df" class="bulleted-list"><li style="list-style-type:disc"><strong>功能</strong>:<ul id="f9909bed-4d7b-4751-bcb6-d6fff9fd5a81" class="bulleted-list"><li style="list-style-type:circle">该方法解析输入的 SQL 表达式，将其转换为 Calcite 的 <code>SqlNode</code> 对象。</li></ul><ul id="7fda4211-a9db-42d6-8f8e-830691a36bef" class="bulleted-list"><li style="list-style-type:circle">首先，通过 <code>SqlValidatorWithHints</code> 验证表达式是否包含保留字，如果是，则将表达式包裹在反引号中。</li></ul><ul id="184b237e-ff20-4d0d-8195-19b01bddfa27" class="bulleted-list"><li style="list-style-type:circle">然后使用 Calcite 的 <code>SqlParser</code> 进行 SQL 解析，将其转换为 <code>SqlNode</code>。</li></ul><ul id="81503a09-13ee-448e-a9f1-dd7235e41164" class="bulleted-list"><li style="list-style-type:circle">最后，对解析后的 <code>SqlNode</code> 进行验证（如语法检查）。</li></ul></li></ul><ol type="1" id="70b142da-79c4-4d33-a99e-c4c115230d0f" class="numbered-list" start="1"><li><strong>buildAs</strong> 方法</li></ol><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7041417f-f335-4ffa-b9a4-72c8c206e4c4" class="code"><code class="language-Java" style="white-space:pre-wrap;word-break:break-all">public static SqlNode buildAs(String asName, SqlNode sqlNode) throws Exception {
    SqlAsOperator sqlAsOperator = new SqlAsOperator();
    SqlIdentifier sqlIdentifier = new SqlIdentifier(asName, SqlParserPos.ZERO);
    return new SqlBasicCall(sqlAsOperator, new ArrayList&lt;&gt;(Arrays.asList(sqlNode, sqlIdentifier)),
            SqlParserPos.ZERO);
}</code></pre><ul id="0f9813c7-b434-4341-b1a2-541080db2633" class="bulleted-list"><li style="list-style-type:disc"><strong>功能</strong>:<ul id="6da5cef0-b3d4-4b18-b7a5-8c426fe70477" class="bulleted-list"><li style="list-style-type:circle">构建一个 SQL 的 <code>AS</code> 操作（用于给表达式或字段起别名）。</li></ul><ul id="5f107693-856c-4d45-9cd6-6d2e3aadd571" class="bulleted-list"><li style="list-style-type:circle"><code>sqlNode</code> 是需要重命名的 SQL 表达式或字段，而 <code>asName</code> 是新名称。</li></ul><ul id="03daed43-2877-4647-9003-00a06849b7f8" class="bulleted-list"><li style="list-style-type:circle">返回一个包含 <code>AS</code> 操作的 <code>SqlNode</code>。</li></ul></li></ul><ol type="1" id="86134ced-ae86-498e-968e-aad53c35cefe" class="numbered-list" start="1"><li><strong>getSql</strong> 方法</li></ol><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="5d3edf02-8d9a-4a4c-a932-18acbc1b9881" class="code"><code class="language-Java" style="white-space:pre-wrap;word-break:break-all">public static String getSql(SqlNode sqlNode, EngineType engineType) {
    UnaryOperator&lt;SqlWriterConfig&gt; sqlWriterConfigUnaryOperator = (c) -&gt; getSqlWriterConfig(engineType);
    return sqlNode.toSqlString(sqlWriterConfigUnaryOperator).getSql();
}</code></pre><ul id="5c3a7090-84b6-4391-ac74-83ea08871548" class="bulleted-list"><li style="list-style-type:disc"><strong>功能</strong>:<ul id="330f3412-71f8-43b2-acd2-614056ad438b" class="bulleted-list"><li style="list-style-type:circle">将 <code>SqlNode</code> 转换为 SQL 字符串表示。</li></ul><ul id="b02e44c6-0c53-4926-96bc-79794e312ee0" class="bulleted-list"><li style="list-style-type:circle">通过 <code>SqlWriterConfig</code> 配置 SQL 的输出格式，生成适合指定 <code>engineType</code>（引擎类型）的 SQL 语句。</li></ul></li></ul><ol type="1" id="45fe86e3-e8ca-4fe7-8674-ffe80c30330f" class="numbered-list" start="1"><li><strong>isNumeric</strong> 方法</li></ol><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0fc931fd-8623-4160-8c98-4fe64e4ccc65" class="code"><code class="language-Java" style="white-space:pre-wrap;word-break:break-all">public static boolean isNumeric(String expr) {
    return StringUtils.isNumeric(expr);
}</code></pre><ul id="04a9a523-a8ea-4076-b667-8b6ff18664a4" class="bulleted-list"><li style="list-style-type:disc"><strong>功能</strong>:<ul id="6240ad55-ca6d-420d-a42a-508ba85a4f10" class="bulleted-list"><li style="list-style-type:circle">检查给定的表达式 <code>expr</code> 是否为数值。该方法利用 Apache Commons Lang3 库中的 <code>StringUtils.isNumeric</code> 方法。</li></ul></li></ul><ol type="1" id="231ff685-8cd5-4575-80ed-7d3d87f79fd9" class="numbered-list" start="1"><li><strong>expand</strong> 方法</li></ol><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7cf57624-8c29-4296-ac8b-1e5aca56374c" class="code"><code class="language-Java" style="white-space:pre-wrap;word-break:break-all">public static List&lt;SqlNode&gt; expand(SqlNode sqlNode, SqlValidatorScope scope) throws Exception {
    if (!isIdentifier(sqlNode)) {
        List&lt;SqlNode&gt; sqlNodeList = new ArrayList&lt;&gt;();
        expand(sqlNode, sqlNodeList);
        return sqlNodeList;
    }
    return new ArrayList&lt;&gt;(Arrays.asList(sqlNode));
}</code></pre><ul id="fba6a467-a09e-4893-bed0-44bb049319c7" class="bulleted-list"><li style="list-style-type:disc"><strong>功能</strong>:<ul id="488df233-1edd-462b-acec-eedddb033d4b" class="bulleted-list"><li style="list-style-type:circle">递归地展开 <code>SqlNode</code>，将复杂的表达式分解成更小的组成部分（如字段标识符、操作符等）。</li></ul><ul id="d5d41677-be3e-420c-9263-151bade6c38e" class="bulleted-list"><li style="list-style-type:circle">该方法用于处理和拆解复杂的 SQL 表达式，使其便于进一步的处理和分析。</li></ul></li></ul><ol type="1" id="2ed7f964-5427-4b4e-83e7-d5f25b021baa" class="numbered-list" start="1"><li><strong>optimize</strong> 方法</li></ol><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b1950933-e116-4e69-8d4b-48239b03ab78" class="code"><code class="language-Java" style="white-space:pre-wrap;word-break:break-all">public static SqlNode optimize(SqlValidatorScope scope, SemanticSchema schema, SqlNode sqlNode,
                               EngineType engineType) {
    try {
        HepProgramBuilder hepProgramBuilder = new HepProgramBuilder();
        SemanticSqlDialect sqlDialect = SqlDialectFactory.getSqlDialect(engineType);
        hepProgramBuilder.addRuleInstance(new FilterToGroupScanRule(FilterToGroupScanRule.DEFAULT, schema));
        RelOptPlanner relOptPlanner = new HepPlanner(hepProgramBuilder.build());
        RelToSqlConverter converter = new RelToSqlConverter(sqlDialect);
        SqlValidator sqlValidator = Configuration.getSqlValidator(
                scope.getValidator().getCatalogReader().getRootSchema(), engineType);
        SqlToRelConverter sqlToRelConverter = Configuration.getSqlToRelConverter(scope, sqlValidator,
                relOptPlanner, engineType);
        RelNode sqlRel = sqlToRelConverter.convertQuery(
                sqlValidator.validate(sqlNode), false, true).rel;
        log.debug(&quot;RelNode optimize {}&quot;,
                SemanticNode.getSql(converter.visitRoot(sqlRel).asStatement(), engineType));
        relOptPlanner.setRoot(sqlRel);
        RelNode relNode = relOptPlanner.findBestExp();
        return converter.visitRoot(relNode).asStatement();
    } catch (Exception e) {
        log.error(&quot;optimize error {}&quot;, e);
    }
    return null;
}</code></pre><ul id="08ae8011-2e84-469e-835c-459d7aa6304f" class="bulleted-list"><li style="list-style-type:disc"><strong>功能</strong>:<ul id="399ca702-ed2d-4292-8983-9ac6ad461c06" class="bulleted-list"><li style="list-style-type:circle">该方法对 <code>SqlNode</code> 进行优化，将其转换为 Calcite 的 <code>RelNode</code> 形式，并通过优化器（<code>HepPlanner</code>）进行优化处理。</li></ul><ul id="f9bc919c-da43-4ce1-a13a-dd0f13019a56" class="bulleted-list"><li style="list-style-type:circle">之后将优化后的 <code>RelNode</code> 再转换为 SQL 语句（<code>SqlNode</code>），并返回。</li></ul><ul id="fde3eefd-01e4-4357-b989-86e5b45e6c27" class="bulleted-list"><li style="list-style-type:circle">这个过程包含 SQL 验证、转换为关系代数形式（RelNode）、应用优化规则等步骤。</li></ul></li></ul><p id="f0f9595d-fe91-4f90-a1b5-ec9ee5840f02" class="">
</p><h2 id="7f795eec-57f4-46c2-9cd4-e6f9dcb9fa5e" class="">14. <code>14:57:22 [http-nio-9080-exec-2] DEBUG c.t.s.h.c.t.c.sql.node.SemanticNode 423 - RelNode optimize SELECT SUM(`pv`)<br/>FROM<br/>(SELECT `imp_date` AS `sys_imp_date`, SUM(1) AS `pv`<br/>FROM<br/>s2_pv_uv_statis<br/>GROUP BY `imp_date`) AS `t1`<br/>WHERE `sys_imp_date` &gt;= &#x27;2024-07-31&#x27; AND `sys_imp_date` &lt;= &#x27;2024-08-06&#x27;<br/></code></h2><h3 id="f11f5a98-aa06-478f-a614-1982b9e6aebd" class="">结合代码分析</h3><ol type="1" id="53932154-2c8e-463f-9e34-a3b22af6256e" class="numbered-list" start="1"><li><strong>SQL 查询结构</strong>:<ul id="0334b6ea-c939-4097-a151-97d2448bdb91" class="bulleted-list"><li style="list-style-type:disc">最外层的查询语句是 <code>SELECT SUM(pv) FROM ... WHERE sys_imp_date &gt;= &#x27;2024-07-31&#x27; AND sys_imp_date &lt;= &#x27;2024-08-06&#x27;</code>。</li></ul><ul id="c28bcb0d-1832-4ff1-b4f7-088c4c028e98" class="bulleted-list"><li style="list-style-type:disc">内层子查询为 <code>SELECT imp_date AS sys_imp_date, SUM(1) AS pv FROM s2_pv_uv_statis GROUP BY imp_date</code>。</li></ul></li></ol><ol type="1" id="159a50d6-2a6c-43e8-9467-f84d60d49ef9" class="numbered-list" start="2"><li><strong>子查询</strong>:<ul id="67b603f8-283d-4af4-8705-24c90bcfe404" class="bulleted-list"><li style="list-style-type:disc">内层子查询从 <code>s2_pv_uv_statis</code> 表中选取数据，将 <code>imp_date</code> 字段重命名为 <code>sys_imp_date</code>。</li></ul><ul id="10d5f9bd-93ca-49c0-8eb8-8ccca90a77ca" class="bulleted-list"><li style="list-style-type:disc">同时，对于每个 <code>imp_date</code>，计算其对应的 <code>pv</code>（访问次数）的总和。这里的 <code>SUM(1)</code> 表示对每一行的计数，通常是计算某个条件下的行数总和。</li></ul></li></ol><ol type="1" id="aab76762-12a9-40e2-80cf-02a697cfc4d6" class="numbered-list" start="3"><li><strong>外层查询</strong>:<ul id="aa49b4fc-374a-406c-bb21-6b7834ac6d7c" class="bulleted-list"><li style="list-style-type:disc">外层查询对内层查询的结果进行汇总，计算出 <code>pv</code> 字段（即访问次数）的总和。</li></ul><ul id="34a2cace-d684-4168-aef0-10de4f686485" class="bulleted-list"><li style="list-style-type:disc">并对 <code>sys_imp_date</code> 进行过滤，只选取在 <code>&#x27;2024-07-31&#x27;</code> 和 <code>&#x27;2024-08-06&#x27;</code> 之间的日期范围的数据。</li></ul></li></ol><h3 id="59b39d33-925e-46c3-bc93-a1ea696db231" class="">Calcite 解析和优化过程</h3><p id="83dc8903-3a05-4760-b594-7085d1e154e3" class="">在 <code>SemanticNode</code> 类中，有一个核心的 <code>optimize</code> 方法负责优化 SQL 查询。</p><ol type="1" id="b8ca57f8-f9d7-48b8-98a5-b25800324862" class="numbered-list" start="1"><li><strong>初始解析</strong>:<ul id="37e009bb-ac33-48ec-a96d-f45d50612cc6" class="bulleted-list"><li style="list-style-type:disc">通过 <code>SqlParser</code> 解析原始的 SQL 表达式，生成 <code>SqlNode</code>。</li></ul></li></ol><ol type="1" id="ef8845d4-d3b8-494b-9ebb-588b8ab077f4" class="numbered-list" start="2"><li><strong>SQL 验证</strong>:<ul id="d0748544-3070-46b0-ab80-162983aec896" class="bulleted-list"><li style="list-style-type:disc">使用 <code>SqlValidator</code> 对 <code>SqlNode</code> 进行验证，检查语法和语义上的合法性。</li></ul></li></ol><ol type="1" id="7ac84274-1850-43c6-b3e9-e7f3df95e11e" class="numbered-list" start="3"><li><strong>转换为 RelNode</strong>:<ul id="51e5bf47-b101-4120-9d89-ed7e11bad612" class="bulleted-list"><li style="list-style-type:disc"><code>SqlToRelConverter</code> 将经过验证的 <code>SqlNode</code> 转换为 <code>RelNode</code>，这一步将 SQL 语句转化为 Calcite 内部使用的关系代数树。</li></ul></li></ol><ol type="1" id="d155bac7-854e-49b4-aae3-9b6cbddd3f8d" class="numbered-list" start="4"><li><strong>优化</strong>:<ul id="efa42d00-7dfe-4cfe-a0b7-3fed8c676054" class="bulleted-list"><li style="list-style-type:disc"><code>HepPlanner</code> 使用一组优化规则（如合并过滤条件、推导下推、消除冗余等）对生成的 <code>RelNode</code> 进行优化。这个过程中可能会对查询进行重写，生成更高效的执行计划。</li></ul></li></ol><ol type="1" id="35da537b-0750-4a1a-99d5-a48054208d2c" class="numbered-list" start="5"><li><strong>生成最终 SQL</strong>:<ul id="cacaf22a-9715-4dbf-8121-9580a4e6e281" class="bulleted-list"><li style="list-style-type:disc">经过优化后的 <code>RelNode</code> 再次转换回 <code>SqlNode</code>，最后由 <code>RelToSqlConverter</code> 生成最终的 SQL 字符串。</li></ul></li></ol><h3 id="4b03da21-03c3-4a17-9b92-c0e34843791f" class="">总结</h3><p id="776b28e2-b2b9-4014-88cc-1fb09fe312f6" class="">这条日志展示了 Calcite 在优化 SQL 查询后的结果。具体来说，Calcite 通过以下步骤生成了最终 SQL：</p><ol type="1" id="ae8f7d03-aa6e-4769-90e9-a0f4c47bf16b" class="numbered-list" start="1"><li>内层子查询通过聚合和分组将原始数据表 <code>s2_pv_uv_statis</code> 中的数据按日期分组，并计算每个日期对应的 <code>pv</code>。</li></ol><ol type="1" id="0e11ec1c-84de-4000-9c32-1bf9bd31221b" class="numbered-list" start="2"><li>外层查询汇总了 <code>pv</code> 的总和，并通过日期范围过滤符合条件的数据。</li></ol><ol type="1" id="08ce9f11-7f20-4f4a-b7d8-a659dbb72a5d" class="numbered-list" start="3"><li>这种嵌套查询的形式可能是经过 Calcite 的优化规则决定的，以实现更高效的数据查询和处理。</li></ol><p id="56859548-8e8a-4fa1-aa94-cc96a1554f8b" class="">
</p><h2 id="f96813db-b150-4f66-b790-2d2008ba9883" class="">15. </h2><h3 id="92c61ab3-bcce-4b2f-9165-a1e204120b50" class="">日志解析</h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="e93586ac-e2a1-4521-af95-6482a4938888" class="code"><code class="language-Plain Text">14:57:22 [http-nio-9080-exec-2] DEBUG o.apache.calcite.plan.RelOptPlanner 45 - call#0: Apply rule [FilterToGroupScanRule] to [rel#49:LogicalFilter,rel#47:LogicalProject,rel#45:LogicalAggregate,rel#43:LogicalProject]
14:57:22 [http-nio-9080-exec-2] DEBUG o.a.c.p.A.rule_execution_summary 300 - Rule Attempts Info for HepPlanner
14:57:22 [http-nio-9080-exec-2] DEBUG o.a.c.p.A.rule_execution_summary 301 -
Rules                                                                   Attempts           Time (us)
FilterToGroupScanRule                                                          1                 968
* Total                                                                        1                 968</code></pre><h3 id="5f90b798-4785-424f-97f7-6be4cae63f4d" class="">日志内容解析</h3><ol type="1" id="d1b36863-cfc5-4ba6-916a-9ea738ae9619" class="numbered-list" start="1"><li><strong>Rule Application (</strong><code><strong>RelOptPlanner</strong></code><strong> 规则应用)</strong>:<ul id="961e64e7-1a7b-4bdf-9825-8409a4050889" class="bulleted-list"><li style="list-style-type:disc"><code>RelOptPlanner</code> 是 Calcite 中用于优化关系代数表达式的规划器。它通过应用一系列规则来优化查询执行计划。</li></ul><ul id="8aaf3e8d-6505-4a4e-a043-66bc835b55c2" class="bulleted-list"><li style="list-style-type:disc"><code>call#0: Apply rule [FilterToGroupScanRule]</code> 这条日志表明，规划器正在应用 <code>FilterToGroupScanRule</code> 规则，并将它应用到了一组逻辑操作符上：<ul id="b0d1a208-9612-4b3a-9ef0-2ef5f6708556" class="bulleted-list"><li style="list-style-type:circle"><code>LogicalFilter</code> (rel#49)</li></ul><ul id="08a6ca13-fe24-477f-86cd-e10c70bfec76" class="bulleted-list"><li style="list-style-type:circle"><code>LogicalProject</code> (rel#47)</li></ul><ul id="3a947795-5b9b-4231-ba58-f7e4e3c419fa" class="bulleted-list"><li style="list-style-type:circle"><code>LogicalAggregate</code> (rel#45)</li></ul><ul id="1ae73670-79fa-4e2d-a82f-59cc9f20f69e" class="bulleted-list"><li style="list-style-type:circle"><code>LogicalProject</code> (rel#43)</li></ul></li></ul></li></ol><ol type="1" id="3600167f-a85c-4ec0-98aa-0617c894c21f" class="numbered-list" start="2"><li><strong>Rule Execution Summary (规则执行摘要)</strong>:<ul id="6d8fa6cf-20fa-46da-a0a6-c1c40649f872" class="bulleted-list"><li style="list-style-type:disc"><code>Rule Attempts Info for HepPlanner</code> 这一部分日志给出了一个摘要，显示了 HepPlanner 在应用优化规则时的尝试次数和所用时间。</li></ul><ul id="57feb338-8bff-43a6-81b0-faa62941553f" class="bulleted-list"><li style="list-style-type:disc"><code>FilterToGroupScanRule</code> 规则在一次尝试中成功应用，并花费了 968 微秒（0.968 毫秒）的时间完成了这一操作。</li></ul></li></ol><h3 id="63469696-7f43-470c-8c37-f42d0efb80d3" class=""><code>FilterToGroupScanRule</code> 规则</h3><p id="298be567-e1e5-44e9-9312-e3e39db60dc3" class=""><code>FilterToGroupScanRule</code> 是 Calcite 中的一条优化规则，通常用于将 <code>Filter</code> 操作符下推到 <code>GroupBy</code> 之前的阶段，从而减少要处理的数据量。这种操作通常可以提高查询的效率，因为在数据聚合之前就已经将不必要的数据过滤掉了。</p><h3 id="16898aeb-d90b-4545-af23-05ee623b3a67" class="">结合之前的查询优化</h3><p id="093193ca-dc02-4d55-ae2b-a24346404614" class="">在之前的日志中，SQL 查询被转换为一个嵌套查询结构，并且在外层有一个过滤条件。<code>FilterToGroupScanRule</code> 识别到了可以在聚合之前应用过滤条件的机会，从而调整了逻辑计划中的操作符顺序，以实现更有效的执行计划。</p><ul id="7f2162a2-90cd-424d-80be-609bfb85454e" class="bulleted-list"><li style="list-style-type:disc"><strong>Initial Plan</strong>:<ul id="3dbbbc8f-a817-4ee8-804b-6d703a92b681" class="bulleted-list"><li style="list-style-type:circle"><code>LogicalProject</code> → <code>LogicalAggregate</code> → <code>LogicalFilter</code> → <code>LogicalProject</code></li></ul></li></ul><ul id="2dc76fd0-2ab4-4442-a6d6-7ea840d84c04" class="bulleted-list"><li style="list-style-type:disc"><strong>Optimized Plan</strong>:<ul id="6bb8aad6-1b64-4df5-a3fe-67d4e9c640ef" class="bulleted-list"><li style="list-style-type:circle"><code>LogicalFilter</code> 被下推到 <code>LogicalAggregate</code> 之前，这样可以先过滤数据再进行聚合操作。</li></ul></li></ul><p id="6c0253ff-3003-4c86-a9e4-71a85b6ca51c" class="">
</p><h2 id="fde15f63-d2e8-4539-a4e2-dc8ed822d40f" class="">16.</h2><h3 id="fb3b6dc6-fe54-4c44-80e9-f953d144c78b" class="">日志分析</h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7539a525-7a55-4a0d-a7d5-6df10466451a" class="code"><code class="language-Plain Text">14:57:22 [http-nio-9080-exec-2] DEBUG o.apache.calcite.plan.RelOptPlanner 380 - For final plan, using rel#53:LogicalAggregate.(input=HepRelVertex#52,group={},EXPR$0=SUM($0))
14:57:22 [http-nio-9080-exec-2] DEBUG o.apache.calcite.plan.RelOptPlanner 380 - For final plan, using rel#51:LogicalProject.(input=HepRelVertex#50,exprs=[$1])
14:57:22 [http-nio-9080-exec-2] DEBUG o.apache.calcite.plan.RelOptPlanner 380 - For final plan, using rel#49:LogicalFilter.(input=HepRelVertex#48,condition=AND(&gt;=($0, _UTF-8&#x27;2024-07-31&#x27;), &lt;=($0, _UTF-8&#x27;2024-08-06&#x27;)))
14:57:22 [http-nio-9080-exec-2] DEBUG o.apache.calcite.plan.RelOptPlanner 380 - For final plan, using rel#47:LogicalProject.(input=HepRelVertex#46,inputs=0..1)
14:57:22 [http-nio-9080-exec-2] DEBUG o.apache.calcite.plan.RelOptPlanner 380 - For final plan, using rel#45:LogicalAggregate.(input=HepRelVertex#44,group={0},pv=SUM($1))
14:57:22 [http-nio-9080-exec-2] DEBUG o.apache.calcite.plan.RelOptPlanner 380 - For final plan, using rel#43:LogicalProject.(input=HepRelVertex#42,exprs=[$4, 1])
14:57:22 [http-nio-9080-exec-2] DEBUG o.apache.calcite.plan.RelOptPlanner 380 - For final plan, using rel#22:LogicalTableScan.(table=[s2_pv_uv_statis])</code></pre><h3 id="4159df52-bfc6-4dca-8c89-bd2aaeeebdd9" class="">1. <code><strong>rel#53:LogicalAggregate</strong></code></h3><ul id="bc60db80-9757-4d1f-88e7-3f8f43fb8909" class="bulleted-list"><li style="list-style-type:disc"><strong>操作</strong>: 聚合操作（<code>SUM($0)</code>）。</li></ul><ul id="031db243-0449-477e-8410-3ae723c2f7c6" class="bulleted-list"><li style="list-style-type:disc"><strong>输入</strong>: <code>HepRelVertex#52</code>。</li></ul><ul id="e02ddfc7-fa33-4ba3-9c55-13ce612e2988" class="bulleted-list"><li style="list-style-type:disc"><strong>详细描述</strong>: 这个操作符执行聚合操作，这里是 <code>SUM($0)</code>，表示对之前步骤中的某个列（即第一个列 <code>$0</code>）进行求和操作。这个操作没有 <code>group by</code>，意味着它在整个数据集上计算总和。</li></ul><h3 id="0a780dbb-363b-45ce-ad77-69fd19650101" class="">2. <code><strong>rel#51:LogicalProject</strong></code></h3><ul id="7bc0890b-3710-4312-964e-c738dac40d35" class="bulleted-list"><li style="list-style-type:disc"><strong>操作</strong>: 投影操作。</li></ul><ul id="6e438e86-b790-4aa7-88c2-4e27aa2e51df" class="bulleted-list"><li style="list-style-type:disc"><strong>输入</strong>: <code>HepRelVertex#50</code>。</li></ul><ul id="1c415b38-f900-4b8c-94bf-2ce141fd33c9" class="bulleted-list"><li style="list-style-type:disc"><strong>详细描述</strong>: 该操作符从之前的结果中选择出特定的列（这里是 <code>$1</code> 列）。<code>LogicalProject</code> 用于选择特定的列或对列进行计算。</li></ul><h3 id="8bd86eb2-1509-472e-ac6a-05093cd2ec00" class="">3. <code><strong>rel#49:LogicalFilter</strong></code></h3><ul id="4c001938-8968-46f2-8802-959237d405dd" class="bulleted-list"><li style="list-style-type:disc"><strong>操作</strong>: 过滤操作。</li></ul><ul id="39a13f75-9c88-464c-8641-21be8e9e523d" class="bulleted-list"><li style="list-style-type:disc"><strong>输入</strong>: <code>HepRelVertex#48</code>。</li></ul><ul id="085d3429-8ee5-46b4-aff9-e58c41f3991b" class="bulleted-list"><li style="list-style-type:disc"><strong>过滤条件</strong>: <code>AND(&gt;=($0, _UTF-8&#x27;2024-07-31&#x27;), &lt;=($0, _UTF-8&#x27;2024-08-06&#x27;))</code>。</li></ul><ul id="764968c3-9d05-4019-bbe6-f69e076c4ed8" class="bulleted-list"><li style="list-style-type:disc"><strong>详细描述</strong>: 这个操作符用于过滤数据，只保留满足指定条件的数据行。这里的条件是 <code>sys_imp_date</code> 的值在 <code>2024-07-31</code> 到 <code>2024-08-06</code> 之间。过滤操作通常用于减少后续操作所需处理的数据量。</li></ul><h3 id="da46e057-406e-4722-857e-3063bb600e30" class="">4. <code><strong>rel#47:LogicalProject</strong></code></h3><ul id="9a44328d-af69-4cf6-96bc-d7eaef612d26" class="bulleted-list"><li style="list-style-type:disc"><strong>操作</strong>: 投影操作。</li></ul><ul id="d7149e98-e661-4c67-bae1-c0be1427b89a" class="bulleted-list"><li style="list-style-type:disc"><strong>输入</strong>: <code>HepRelVertex#46</code>。</li></ul><ul id="d2a91bec-ab02-45fc-b547-d42fcc6878e1" class="bulleted-list"><li style="list-style-type:disc"><strong>详细描述</strong>: 另一个投影操作符，从输入数据中选择某些特定列或进行列的计算。这里它将选择列 <code>exprs=[$1]</code>。</li></ul><h3 id="1608ec23-9b79-407d-bb05-abcc7a91d2d1" class="">5. <code><strong>rel#45:LogicalAggregate</strong></code></h3><ul id="11bebd9b-4d29-465f-94ce-11ee15a1fa67" class="bulleted-list"><li style="list-style-type:disc"><strong>操作</strong>: 聚合操作。</li></ul><ul id="d027bb43-d185-49b6-8c93-c3dbaa3382a6" class="bulleted-list"><li style="list-style-type:disc"><strong>输入</strong>: <code>HepRelVertex#44</code>。</li></ul><ul id="1b85d6c7-6809-4238-b97b-ab6fad1fa4f1" class="bulleted-list"><li style="list-style-type:disc"><strong>分组依据</strong>: <code>group={0}</code>，根据第0列进行分组。</li></ul><ul id="a1bd639e-1f1d-4592-9654-8ebea6322c5d" class="bulleted-list"><li style="list-style-type:disc"><strong>聚合操作</strong>: <code>pv=SUM($1)</code>。</li></ul><ul id="aa2f5482-1914-40bc-8e17-770f51a7c19c" class="bulleted-list"><li style="list-style-type:disc"><strong>详细描述</strong>: 这个聚合操作符按照第 <code>0</code> 列进行分组，并对第 <code>1</code> 列的值进行求和操作，计算 <code>pv</code> 的总和。</li></ul><h3 id="5ad890f8-515a-44b6-9b37-fa11f5418153" class="">6. <code><strong>rel#43:LogicalProject</strong></code></h3><ul id="8e9e40ca-c921-4ec1-89f4-947f12d7e60d" class="bulleted-list"><li style="list-style-type:disc"><strong>操作</strong>: 投影操作。</li></ul><ul id="79b6f7a6-4bf8-40ca-bb5d-bfd737dc91b0" class="bulleted-list"><li style="list-style-type:disc"><strong>输入</strong>: <code>HepRelVertex#42</code>。</li></ul><ul id="a5647dec-d624-4d0d-8f78-c76d81ce6a8f" class="bulleted-list"><li style="list-style-type:disc"><strong>详细描述</strong>: 该操作选择第 <code>4</code> 列和常量 <code>1</code>，可能是为了创建一个新的列或者为后续操作做准备。</li></ul><h3 id="87be73fb-68b2-42f1-a367-461086b2db6c" class="">7. <code><strong>rel#22:LogicalTableScan</strong></code></h3><ul id="ff258561-bd14-4459-965e-8afbfc877d38" class="bulleted-list"><li style="list-style-type:disc"><strong>操作</strong>: 表扫描。</li></ul><ul id="5e44d394-193e-412a-9c44-c12858528f5e" class="bulleted-list"><li style="list-style-type:disc"><strong>表</strong>: <code>s2_pv_uv_statis</code>。</li></ul><ul id="cdb5209a-bb52-4416-a590-5f5a7c2c00f9" class="bulleted-list"><li style="list-style-type:disc"><strong>详细描述</strong>: 这是整个查询操作的起点，表示对物理表 <code>s2_pv_uv_statis</code> 进行扫描，读取所有相关数据。<code>LogicalTableScan</code> 通常是最底层的操作符，用于从数据库中读取数据。</li></ul><h3 id="6522c232-e54a-46b3-9177-7919507438ed" class="">总结</h3><p id="bafa3a8f-65de-430e-bc43-b1f40e6ad1d4" class="">这段日志显示了 Calcite 在优化 SQL 查询时生成的最终逻辑执行计划。该计划首先通过 <code>LogicalTableScan</code> 读取数据，然后通过一系列 <code>LogicalProject</code>、<code>LogicalAggregate</code> 和 <code>LogicalFilter</code> 操作符对数据进行处理。最终的执行计划是通过优化器应用各种规则（例如之前提到的 <code>FilterToGroupScanRule</code>）生成的，以提高查询的执行效率。</p><h2 id="97d1c838-fdd4-4b2e-9a62-007ead8ce8ab" class="">17. </h2><h3 id="181e9698-f675-4bcf-b6dc-dcbd9eff0ffa" class="">1. <code><strong>simplifySql</strong></code><strong> 日志行</strong></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="fb9f81d9-5568-43d9-90ea-fd45fa4a91b2" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">14:57:22 [http-nio-9080-exec-2] DEBUG c.t.s.h.c.t.c.CalciteQueryParser 46 - simplifySql [SELECT SUM(`pv`)
FROM
(SELECT `imp_date` AS `sys_imp_date`, SUM(1) AS `pv`
FROM
s2_pv_uv_statis
GROUP BY `imp_date`) AS `t7`
WHERE `sys_imp_date` &gt;= &#x27;2024-07-31&#x27; AND `sys_imp_date` &lt;= &#x27;2024-08-06&#x27;]</code></pre><ul id="5280c76b-5ee0-4108-bfe0-f79430ed17e3" class="bulleted-list"><li style="list-style-type:disc"><strong>作用</strong>: 这一行展示了 <code>CalciteQueryParser</code> 在简化 SQL 查询时生成的中间 SQL 语句。</li></ul><ul id="f6a865c9-b5d5-4439-a2f1-fdc720f2359f" class="bulleted-list"><li style="list-style-type:disc"><strong>简化后的 SQL</strong>:<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2ebd1eaa-3d33-4073-8b4a-601ae19e40e5" class="code"><code class="language-SQL" style="white-space:pre-wrap;word-break:break-all">SELECT SUM(`pv`)
FROM
(SELECT `imp_date` AS `sys_imp_date`, SUM(1) AS `pv`
FROM
s2_pv_uv_statis
GROUP BY `imp_date`) AS `t7`
WHERE `sys_imp_date` &gt;= &#x27;2024-07-31&#x27; AND `sys_imp_date` &lt;= &#x27;2024-08-06&#x27;</code></pre></li></ul><ul id="6b94a3a0-278f-410b-a844-660c42294880" class="bulleted-list"><li style="list-style-type:disc"><strong>分析</strong>:<ul id="a52a80fc-fb4e-42ec-8f2b-b5890015e659" class="bulleted-list"><li style="list-style-type:circle">该 SQL 查询先从 <code>s2_pv_uv_statis</code> 表中按 <code>imp_date</code> 分组，并计算 <code>SUM(1)</code> 作为 <code>pv</code>。<code>imp_date</code> 被别名为 <code>sys_imp_date</code>。</li></ul><ul id="ef90c72a-32bb-43ec-bb81-cd41a752f721" class="bulleted-list"><li style="list-style-type:circle">然后，外层查询对计算得到的 <code>pv</code> 进行求和，同时通过 <code>sys_imp_date</code> 过滤数据，只保留时间范围在 <code>2024-07-31</code> 到 <code>2024-08-06</code> 之间的记录。</li></ul></li></ul><h3 id="2052b35d-eb3a-4847-a0fd-2a7305d41e38" class="">2. <code><strong>before handleNoMetric</strong></code><strong> 日志行</strong></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="d61f442c-6d88-4dba-810e-83ada06b8d9a" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">14:57:22 [http-nio-9080-exec-2] DEBUG c.t.s.h.c.t.DetailQueryOptimizer 27 - before handleNoMetric, sql:with t_1 as (SELECT `imp_date` AS `sys_imp_date`, SUM(1) AS `pv`
FROM
s2_pv_uv_statis
GROUP BY `imp_date`, `imp_date`)
SELECT SUM(pv) FROM t_1 WHERE (sys_imp_date &gt;= &#x27;2024-07-31&#x27; AND sys_imp_date &lt;= &#x27;2024-08-06&#x27;) limit 1000</code></pre><ul id="1f191ead-9a17-41ac-8c05-3fe61d678ce8" class="bulleted-list"><li style="list-style-type:disc"><strong>作用</strong>: <code>DetailQueryOptimizer</code> 显示了在执行 <code>handleNoMetric</code> 优化前的 SQL 查询。</li></ul><ul id="62200e2b-1909-4dad-8374-87174e792aa5" class="bulleted-list"><li style="list-style-type:disc"><strong>SQL 语句</strong>:<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="afaf3f21-ac81-49a1-81b3-fd77314c4b88" class="code"><code class="language-SQL" style="white-space:pre-wrap;word-break:break-all">with t_1 as (
    SELECT `imp_date` AS `sys_imp_date`, SUM(1) AS `pv`
    FROM s2_pv_uv_statis
    GROUP BY `imp_date`, `imp_date`
)
SELECT SUM(pv) FROM t_1 WHERE (sys_imp_date &gt;= &#x27;2024-07-31&#x27; AND sys_imp_date &lt;= &#x27;2024-08-06&#x27;) limit 1000</code></pre></li></ul><ul id="abcda927-7f9f-4413-81c4-b0eb7198be2c" class="bulleted-list"><li style="list-style-type:disc"><strong>分析</strong>:<ul id="5dd257eb-16b2-47b1-abb2-637fca46a576" class="bulleted-list"><li style="list-style-type:circle">这段 SQL 使用了一个 <code>WITH</code> 子句，将子查询结果命名为 <code>t_1</code>。</li></ul><ul id="21991aaa-4195-43b2-b8ab-8012e2c0b100" class="bulleted-list"><li style="list-style-type:circle">子查询内容与上面简化后的 SQL 基本相同，但这里 <code>GROUP BY</code> 中重复指定了 <code>imp_date</code>。</li></ul><ul id="b4a45c9e-e41c-4f65-8e2d-057e769fc06e" class="bulleted-list"><li style="list-style-type:circle">最终查询的目的是对 <code>t_1</code> 中满足日期条件的 <code>pv</code> 进行求和，且限制结果集为 1000 行。</li></ul></li></ul><h3 id="ca8fa3c7-d0c0-4b1b-baee-2aff99359f91" class="">3. <code><strong>after handleNoMetric</strong></code><strong> 日志行</strong></h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a0d94bbb-d83d-4f2b-bd29-778f38d9778a" class="code"><code class="language-Plain Text" style="white-space:pre-wrap;word-break:break-all">14:57:22 [http-nio-9080-exec-2] DEBUG c.t.s.h.c.t.DetailQueryOptimizer 36 - after handleNoMetric, sql:with t_1 as (SELECT `imp_date` AS `sys_imp_date`, SUM(1) AS `pv`
FROM
s2_pv_uv_statis
GROUP BY `imp_date`, `imp_date`)
SELECT SUM(pv) FROM t_1 WHERE (sys_imp_date &gt;= &#x27;2024-07-31&#x27; AND sys_imp_date &lt;= &#x27;2024-08-06&#x27;) limit 1000</code></pre><ul id="28b12959-1adc-45f0-ac70-5b24e61ef026" class="bulleted-list"><li style="list-style-type:disc"><strong>作用</strong>: <code>DetailQueryOptimizer</code> 显示了在执行 <code>handleNoMetric</code> 优化后的 SQL 查询。优化前后的 SQL 并没有变化，这表明在此优化步骤中，SQL 语句已经达到最佳状态，或者该优化步骤对该查询没有进一步的优化空间。</li></ul><ul id="3638b681-2274-420a-875f-60b7e860b389" class="bulleted-list"><li style="list-style-type:disc"><strong>SQL 语句</strong>:<ul id="4d0e47d3-47e0-4ab4-b177-a627b4a5e56b" class="bulleted-list"><li style="list-style-type:circle">与优化前的 SQL 语句相同。</li></ul></li></ul></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body></html>